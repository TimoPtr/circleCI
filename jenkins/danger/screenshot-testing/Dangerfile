# Danger is a highly customizable tool for automatic code review.
# On its own, it does nothing except interpreting the custom rules we provide in this file.

# However, it has plugins (like 'danger-android_lint') which can allow us to digest reports, like lint.

# Official and well detailed documentation of this tool can be found here : https://danger.systems/ruby/
# The upper link also provides an exhaustive list of all Danger plugins which can be installed.

# All the Danger scoped variable can be found here : https://danger.systems/reference.html

verification_failed = ENV['DANGER_SCREENSHOT_VERIFICATION_FAILED'] == 'true'
build_url = ENV['BUILD_URL']
flavour = ENV['DANGER_SCREENSHOT_TESTING_FLAVOUR']

report_url = build_url + "/artifact/" + flavour + "-screenshot-report.tar.gz"
failure_report_url = build_url + "/artifact/" + flavour + "-screenshot-failure-report.tar.gz"
log_url = build_url + "/console"

screenshot_message = 'ðŸ“º We detected an issue during verification of screenshots generated by this PR. ðŸ“º'

screenshot_message << '<h3>Possible causes</h3>'
screenshot_message << '<ul>'
screenshot_message << '  <li>You added new screenshot in your Espresso tests and we don\'t have a reference image saved yet</li>'
screenshot_message << '  <li>You refactored a view so its visuals changed - reference image should be updated</li>'
screenshot_message << '  <li>String has been updadted in POEditor - reference image should be updated</li>'
screenshot_message << '</ul>'
screenshot_message << 'If none of those scenarios apply to your PR, this could mean that you accidently introduced some regressions. But no worries, let\'s fix that together ðŸ’ªðŸ™‚'

screenshot_message << '<h3>How to proceed</h3>'
screenshot_message << '<ol>'
screenshot_message << '  <li>Check <a href="' + failure_report_url + '">failures report</a> first. If there are differences between any of the master screenshots and the ones generated from your PR, this is the place to check that. The folder contains a list of triples - original, current and diff. Check if the report is not empty and if it\'s not - does it contain any differences that you find unexpected.</li>'
screenshot_message << '  <li>Then, check <a href="' + report_url + '">full HTML report</a>. It will help you to determine if changes and/or new screenshots you introduced are correct.</li>'
screenshot_message << '  <li>If you haven\'t found anything unexpected, it should be safe to update the master screenshot set with your changes. Accept <a href="' + log_url + '">the input in your build\'s log.</a> to do that.</li>'
screenshot_message << '</ol>'

markdown screenshot_message if verification_failed
failure 'Screenshot tests failed for ' + flavour if verification_failed